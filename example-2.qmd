---
title: "Module 1: Tabular Data"
subtitle: "Working with larger than RAM data using duckdbfs"
format:
  pdf:
    number-sections: true
    colorlinks: true
---

```{r}
#| include: false
library(duckdbfs)
library(dplyr)
library(ggplot2)
library(knitr)

# Set default chunk options
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)
```


```{r}
#| output: false
# Remote S3 path to EXIOBASE 3 (Source Cooperative)
duckdbfs::duckdb_secrets(
    key = "",
    secret = "",
    endpoint = "s3.amazonaws.com",
    region = "us-west-2"
)
s3_url <- "s3://us-west-2.opendata.source.coop/youssef-harby/exiobase-3/4588235/parquet/**"

# Open the dataset lazily
exio <- open_dataset(s3_url)
```

```{r}
#| output: false
co2 <- exio |>
  filter(matrix == "F_satellite") |>
  filter(grepl("CO2|carbon dioxide", stressor, ignore.case = TRUE))
```

```{r}
top_co2_regions <- co2 |>
    group_by(region) |>
    summarise(total_co2 = sum(value, na.rm = TRUE)) |>
    arrange(desc(total_co2)) |>
    head(5) |>
    collect()

knitr::kable(top_co2_regions, 
             format.args = list(big.mark = ","),
             caption = "Top 5 Regions by Total CO2 Emissions")
```


```{r}
#| fig-width: 8
#| fig-height: 6
# Get the list of top regions
top_regions <- top_co2_regions$region

# Filter co2 data to top regions and summarize by year
co2_by_year <- co2 |>
  filter(region %in% top_regions) |>
  group_by(region, year) |>
  summarise(total_co2 = sum(value, na.rm = TRUE), .groups = "drop") |>
  collect()

# Plot emissions by year for top countries
ggplot(co2_by_year, aes(x = year, y = total_co2, color = region)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(
    title = "CO2 Emissions Over Time for Top 5 Regions",
    x = "Year",
    y = "Total CO2 Emissions",
    color = "Region"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 9)
  ) +
  guides(color = guide_legend(nrow = 1))
```


```{r}
# Find top 5 sectors in US for 2022
top_us_sectors_2022 <- co2 |>
  filter(region == "US") |>
  filter(year == 2022) |>
  group_by(sector) |>
  summarise(total_co2 = sum(value, na.rm = TRUE)) |>
  arrange(desc(total_co2)) |>
  head(5) |>
  collect()

knitr::kable(top_us_sectors_2022, 
             format.args = list(big.mark = ","),
             caption = "Top 5 US Sectors by CO2 Emissions in 2022")
```

```{r}
#| fig-width: 8
#| fig-height: 6
# Get the list of top sectors
top_sectors <- top_us_sectors_2022$sector

# Filter co2 data to US and top sectors, summarize by year
us_sectors_by_year <- co2 |>
  filter(region == "US") |>
  filter(sector %in% top_sectors) |>
  group_by(sector, year) |>
  summarise(total_co2 = sum(value, na.rm = TRUE), .groups = "drop") |>
  collect()

# Plot emissions by year for top US sectors
ggplot(us_sectors_by_year, aes(x = year, y = total_co2, color = sector)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(
    title = "CO2 Emissions Over Time for Top 5 US Sectors (by 2022 emissions)",
    x = "Year",
    y = "Total CO2 Emissions",
    color = "Sector"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 8)
  ) +
  guides(color = guide_legend(nrow = 2))
```

```{r}
top_sectors <- co2 |>
    group_by(sector) |>
    summarise(total_co2 = sum(value, na.rm = TRUE), .groups="drop") |>
    arrange(desc(total_co2)) |>
    head(5) |>
    collect()

knitr::kable(top_sectors, 
             format.args = list(big.mark = ","),
             caption = "Top 5 Global Sectors by Total CO2 Emissions")
```

```{r}
#| fig-width: 8
#| fig-height: 6
# Create bar chart of top 5 sectors
ggplot(top_sectors, aes(x = reorder(sector, -total_co2), y = total_co2, fill = sector)) +
  geom_col() +
  labs(
    title = "Top 5 Global Sectors by Total CO2 Emissions",
    x = "Sector",
    y = "Total CO2 Emissions"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    legend.position = "none",
    plot.margin = margin(10, 10, 20, 10)
  ) +
  scale_y_continuous(labels = scales::comma)
```
