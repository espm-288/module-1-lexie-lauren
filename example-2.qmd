---
title: "Module 1: Tabular Data"
subtitle: "Working with larger than RAM data using duckdbfs"
format:
  html:
    embed-resources: true
    code-fold: true
    code-tools: true
    df-print: kable
---
Explaining our analysis and so forth. 

```{r}
#| include: false
library(duckdbfs)
library(dplyr)
library(ggplot2)
library(knitr)

# Set default chunk options
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE
)
```


```{r}
#| output: false
# Remote S3 path to EXIOBASE 3 (Source Cooperative)
duckdbfs::duckdb_secrets(
    key = "",
    secret = "",
    endpoint = "s3.amazonaws.com",
    region = "us-west-2"
)
s3_url <- "s3://us-west-2.opendata.source.coop/youssef-harby/exiobase-3/4588235/parquet/**"

# Open the dataset lazily
exio <- open_dataset(s3_url)
```

```{r}
#| output: false
co2 <- exio |>
  filter(matrix == "F_satellite") |>
  filter(grepl("CO2|carbon dioxide", stressor, ignore.case = TRUE))
```

```{r}
top_co2_regions <- co2 |>
    group_by(region) |>
    summarise(total_co2 = sum(value, na.rm = TRUE)) |>
    arrange(desc(total_co2)) |>
    head(5) |>
    collect()

knitr::kable(top_co2_regions, format.args = list(big.mark = ","))
```

Filter the co2 data down to just these top countries, and plot their total emissions by year.

```{r}
# Get the list of top regions
top_regions <- top_co2_regions$region

# Filter co2 data to top regions and summarize by year
co2_by_year <- co2 |>
  filter(region %in% top_regions) |>
  group_by(region, year) |>
  summarise(total_co2 = sum(value, na.rm = TRUE), .groups = "drop") |>
  collect()

# Plot emissions by year for top countries
ggplot(co2_by_year, aes(x = year, y = total_co2, color = region)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(
    title = "CO2 Emissions Over Time for Top 5 Regions",
    x = "Year",
    y = "Total CO2 Emissions",
    color = "Region"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

Identify the top 5 sectors in the US by CO2 emissions in 2022, and visualize their emissions over time.

```{r}
# Find top 5 sectors in US for 2022
top_us_sectors_2022 <- co2 |>
  filter(region == "US") |>
  filter(year == 2022) |>
  group_by(sector) |>
  summarise(total_co2 = sum(value, na.rm = TRUE)) |>
  arrange(desc(total_co2)) |>
  head(5) |>
  collect()

knitr::kable(top_us_sectors_2022, format.args = list(big.mark = ","))
```

```{r}
# Get the list of top sectors
top_sectors <- top_us_sectors_2022$sector

# Filter co2 data to US and top sectors, summarize by year
us_sectors_by_year <- co2 |>
  filter(region == "US") |>
  filter(sector %in% top_sectors) |>
  group_by(sector, year) |>
  summarise(total_co2 = sum(value, na.rm = TRUE), .groups = "drop") |>
  collect()

# Plot emissions by year for top US sectors
ggplot(us_sectors_by_year, aes(x = year, y = total_co2, color = sector)) +
  geom_line(linewidth = 1) +
  geom_point() +
  labs(
    title = "CO2 Emissions Over Time for Top 5 US Sectors (by 2022 emissions)",
    x = "Year",
    y = "Total CO2 Emissions",
    color = "Sector"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

```{r}
top_sectors <- co2 |>
    group_by(sector) |>
    summarise(total_co2 = sum(value, na.rm = TRUE), .groups="drop") |>
    arrange(desc(total_co2)) |>
    head(5)

all_sectors_by_year <- co2 |>
    inner_join(top_sectors) |>
    group_by(sector, year) |>
    summarise(total_co2 = sum(value, na.rm = TRUE), .groups="drop") |> 
    collect()

knitr::kable(all_sectors_by_year, format.args = list(big.mark = ","))
```
