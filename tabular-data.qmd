---
title: "Module 1: Tabular Data"
subtitle: "Working with larger-than-RAM data using duckdbfs"
author: "ESPM 288"
format:
  html:
    embed-resources: true
    css: custom-style.css
    code-fold: true
    df-print: paged
---

```{css, echo=FALSE}
body {
  background-color: #FFB6C1 !important;
  font-family: 'Comic Sans MS', 'Comic Sans', cursive !important;
}

h1, .title {
  color: #FF1493 !important;
  font-family: 'Comic Sans MS', 'Comic Sans', cursive !important;
}

h2 {
  color: #FF69B4 !important;
  font-family: 'Comic Sans MS', 'Comic Sans', cursive !important;
}

h3 {
  color: #9370DB !important;
  font-family: 'Comic Sans MS', 'Comic Sans', cursive !important;
}

.subtitle {
  color: #FF6347 !important;
  font-family: 'Comic Sans MS', 'Comic Sans', cursive !important;
}

install.packages("quarto")
```

## Introduction

In this module, we will explore high-performance workflows for tabular data. We will use `duckdbfs` to work with datasets that are larger than available RAM by leveraging DuckDB's streaming and remote file access capabilities.

## Case Study: Global Supply Chains

We will be working with [EXIOBASE 3.8.1](https://source.coop/youssef-harby/exiobase-3), a global Multi-Regional Input-Output (MRIO) database. This dataset tracks economic transactions between sectors and regions, along with their environmental impacts (emissions, resource use, etc.).

**Data description:**
- **Coverage**: 44 countries + 5 rest-of-world regions.
- **Timeframe**: 1995â€“2022.
- **Content**: Economic transactions (Z matrix), final demand (Y matrix), and environmental stressors (F matrix).
- **Format**: Cloud-optimized Parquet, partitioned by year and matrix type.

## Setup

```{r}
library(duckdbfs)
library(dplyr)

```

## Exercise 1: connecting to remote data

We can open the entire dataset without downloading it using `open_dataset()`. The data is hosted on Source Cooperative. The `**` pattern allows recursive scanning of the partitioned parquet files.

```{r}
# Remote S3 path to EXIOBASE 3 (Source Cooperative)
duckdbfs::duckdb_secrets(
    key = "",
    secret = "",
    endpoint = "s3.amazonaws.com",
    region = "us-west-2"
)
s3_url <- "s3://us-west-2.opendata.source.coop/youssef-harby/exiobase-3/4588235/parquet/**"

# Open the dataset lazily
exio <- open_dataset(s3_url)

# View the schema (column names and types) without reading data
glimpse(exio)
```

## Exercise 2: Efficient Filtering

The dataset is large. We should filter *before* collecting any data into R.

```{r}
exio |>
    filter(year == 2022, region == "US") |>
    head() |> # view the first 6 rows
    collect()
```

## Exercise 3: CO2 Emissions Analysis

Read CO2 emissions data from the F_satellite matrix and analyze top sectors.

```{r}
# Read CO2 production data from F_satellite matrix
# Filter for CO2-related stressors in 2022
co2_data <- exio |>
    filter(
        year == 2022,
        matrix == "F_satellite",
        stressor %like% "%CO2%"
    ) |>
    collect()

# View the CO2 data
co2_data
glimpse(co2_data)

# Find unique CO2 stressors
unique_stressors <- co2_data |>
    distinct(stressor) |>
    arrange(stressor)

unique_stressors
```

## Exercise 3: Time Series Analysis of Top CO2 Emitters

Now let's create a visualization showing CO2 emissions over time for the top 5 emitting countries.

```{r}
library(ggplot2)

# Get CO2 data, identify top 5 emitters, and create time series
exio |>
    filter(matrix == "F_satellite", stressor %like% "%CO2%") |>
    collect() |>
    group_by(region) |>
    mutate(region_total = sum(value, na.rm = TRUE)) |>
    ungroup() |>
    filter(dense_rank(desc(region_total)) <= 5) |>
    group_by(year, region) |>
    summarize(total_co2 = sum(value, na.rm = TRUE), .groups = "drop") |>
    ggplot(aes(x = year, y = total_co2, color = region)) +
    geom_line(linewidth = 1.2) +
    geom_point(linewidth = 2) +
    labs(
        title = "CO2 Emissions Over Time: Top 5 Emitting Countries",
        x = "Year",
        y = "Total CO2 Emissions",
        color = "Country/Region"
    ) +
    theme_minimal() +
    theme(legend.position = "bottom")
```

## Exercise 4: Top Countries Reducing CO2 Emissions

Let's identify the countries that have achieved the greatest reduction in CO2 emissions from 1995 to 2022.

```{r}
# Calculate emission changes and identify top 5 reducers (individual countries only)
exio |>
    filter(matrix == "F_satellite", stressor %like% "%CO2%") |>
    collect() |>
    filter(!region %in% c("WE", "WA", "WF", "WL", "WM")) |>  # Exclude aggregated regions
    group_by(year, region) |>
    summarize(total_co2 = sum(value, na.rm = TRUE), .groups = "drop") |>
    group_by(region) |>
    filter(n() >= 2) |>  # Ensure at least 2 years of data
    summarize(
        first_year_emissions = total_co2[which.min(year)],
        last_year_emissions = total_co2[which.max(year)],
        change = last_year_emissions - first_year_emissions,
        .groups = "drop"
    ) |>
    arrange(change) |>
    head(5) |>
    ggplot(aes(x = reorder(region, change), y = change, fill = region)) +
    geom_col() +
    geom_text(aes(label = round(change, 0)), hjust = 1.2, color = "white", size = 6) +
    coord_flip() +
    labs(
        title = "Top 5 Countries with Greatest CO2 Emission Reductions",
        subtitle = "Change from 1995 to 2022 (Individual Countries Only)",
        x = "Country/Region",
        y = "Change in CO2 Emissions",
        fill = "Country/Region"
    ) +
    theme_minimal(base_size = 14) +
    theme(
        legend.position = "right",
        plot.title = element_text(size = 16, face = "bold"),
        plot.subtitle = element_text(size = 12),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 13)
    )
```

```{r}
# Find top 5 sectors in the US by CO2 emissions in 2022
top_co2_sectors <- co2_data |>
    filter(region == "US") |>
    group_by(sector) |>
    summarise(total_co2 = sum(value, na.rm = TRUE)) |>
    arrange(desc(total_co2)) |>
    slice_head(n = 5)

top_co2_sectors
```

## Exercise 4: Time Series of Top CO2 Emitting Countries

Visualize CO2 emissions over time for the top 5 emitting countries.

```{r}
library(ggplot2)

# First, get all CO2 data across all years
co2_all_years <- exio |>
    filter(
        matrix == "F_satellite",
        stressor %like% "%CO2%"
    ) |>
    collect()

# Identify top 5 CO2 emitting countries in 2022
top_5_countries <- co2_all_years |>
    filter(year == 2022) |>
    group_by(region) |>
    summarise(total_co2 = sum(value, na.rm = TRUE)) |>
    arrange(desc(total_co2)) |>
    slice_head(n = 5) |>
    pull(region)

# Filter data for top 5 countries across all years
co2_time_series <- co2_all_years |>
    filter(region %in% top_5_countries) |>
    group_by(year, region) |>
    summarise(total_co2 = sum(value, na.rm = TRUE), .groups = "drop")

# Create the plot
ggplot(co2_time_series, aes(x = year, y = total_co2, color = region)) +
    geom_line(linewidth = 1) +
    geom_point() +
    labs(
        title = "CO2 Emissions Over Time: Top 5 Emitting Countries",
        x = "Year",
        y = "Total CO2 Emissions",
        color = "Country"
    ) +
    theme_minimal() +
    theme(legend.position = "bottom")
```

## Exercise 5: Top CO2 Emitting Industries Globally

Identify the top 5 industries/sectors that emit the most CO2 globally in 2022.

```{r}
# Find top 5 industries globally by CO2 emissions in 2022
top_co2_industries <- co2_data |>
    group_by(sector) |>
    summarise(total_co2 = sum(value, na.rm = TRUE)) |>
    arrange(desc(total_co2)) |>
    slice_head(n = 5)

top_co2_industries
```

```{r}
# Visualize top 5 emitting industries
ggplot(top_co2_industries, aes(x = reorder(sector, total_co2), y = total_co2)) +
    geom_col(fill = "steelblue") +
    coord_flip() +
    labs(
        title = "Top 5 CO2 Emitting Industries Globally (2022)",
        x = "Sector",
        y = "Total CO2 Emissions"
    ) +
    theme_minimal()
```

## Exercise 6: types of pollutants

In the US, what are the top 5 sectors with highest emissions in 2022?

```{r}
# Find top 5 sectors with highest total emissions in the US in 2022
top_us_sectors <- exio |>
    filter(year == 2022, matrix == "F_satellite", region == "US") |>
    collect() |>
    group_by(sector) |>
    summarise(total_emissions = sum(value, na.rm = TRUE), .groups = "drop") |>
    arrange(desc(total_emissions)) |>
    slice_head(n = 5)

top_us_sectors
```